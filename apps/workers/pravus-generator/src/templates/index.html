{% extends "base.html" %}
{% block title %}Pravus{% endblock %}
{% block extra_head %}
{% include 'task_management.html' %}
{% endblock %}
{% block body %}

<body class="bg-background text-custom-text px-20 pb-4 pt-8">
    <!-- Custom Confirmation Dialog -->
    <div id="custom-confirm-dialog" class="fixed inset-0 z-100 hidden items-center justify-center bg-white/10">
        <div class="bg-background rounded-2xl shadow-lg p-6 max-w-md w-full border-1 border-custom-border">
            <p id="confirm-message" class="mb-6 text-center"></p>
            <div class="grid grid-cols-3 grid-rows-1 w-full gap-x-4">
                <button type="button" id="confirm-yes-btn"
                    class="py-2 text-center bg-custom-primary border-custom-border border-[0.5px] rounded-2xl col-span-2">
                    Yes, Confirm
                </button>
                <button type="button" id="confirm-no-btn"
                    class="py-2 text-center border-custom-border bg-custom-muted border-[0.5px] rounded-2xl col-span-1">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div class="py-4">
        <div
            class="w-full p-3 bg-primary-gradient hover:bg-primary-gradient-hover rounded-lg flex justify-between items-center">
            <h1 class="font-bold inter-800">Pravus</h1>
        </div>
        {% if form.errors %}
        <ul class="bg-red-200 my-3 border-2 border-red-500 rounded-xl p-3">
            {% for field_name, field_errors in form.errors|dictsort if field_errors %}
            {% for error in field_errors %}
            <li class="text-red-500 my-2">{{ form[field_name].label }}: {{ error }}</li>
            {% endfor %}
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <!-- Main Form -->
    <form id="generation-form" method="POST" action="/" class="flex flex-col md:grid md:grid-cols-5 gap-10"
        enctype="multipart/form-data">
        <!-- Form content unchanged -->
        <div class="flex-col flex">
            <div class="w-full mb-3 bg-custom-gray rounded-lg p-3 border-custom-border border-[0.5px]">
                <h2 class="font-bold inter-800">Scripts</h2>
            </div>
            <!-- Text File Upload Section -->
            <div class="mt-3">
                <div class="w-full">
                    <label for="{{ form.text_files.id }}"
                        class="relative flex flex-col bg-[#26262680] items-center justify-center rounded-xl w-full border-3 border-custom-border/50 border-dashed cursor-pointer hover:bg-transparent hover:border-custom-primary/70">
                        <div class="flex flex-col items-center justify-center py-14">
                            <svg class="text-white/50 size-8" viewBox="0 0 32 32" fill="currentColor"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M4 31.5C2.9 31.5 1.95833 31.1102 1.175 30.3307C0.391667 29.5511 0 28.614 0 27.5193V23.5385C0 22.9746 0.191667 22.5019 0.575 22.1204C0.958333 21.7389 1.43333 21.5482 2 21.5482C2.56667 21.5482 3.04167 21.7389 3.425 22.1204C3.80833 22.5019 4 22.9746 4 23.5385V27.5193H28V23.5385C28 22.9746 28.1917 22.5019 28.575 22.1204C28.9583 21.7389 29.4333 21.5482 30 21.5482C30.5667 21.5482 31.0417 21.7389 31.425 22.1204C31.8083 22.5019 32 22.9746 32 23.5385V27.5193C32 28.614 31.6083 29.5511 30.825 30.3307C30.0417 31.1102 29.1 31.5 28 31.5H4ZM14 7.31701L10.25 11.049C9.85 11.447 9.375 11.6378 8.825 11.6212C8.275 11.6046 7.8 11.3973 7.4 10.9992C7.03333 10.6011 6.84167 10.1367 6.825 9.60594C6.80833 9.07517 7 8.61075 7.4 8.21268L14.6 1.04735C14.8 0.848315 15.0167 0.70733 15.25 0.624398C15.4833 0.541466 15.7333 0.5 16 0.5C16.2667 0.5 16.5167 0.541466 16.75 0.624398C16.9833 0.70733 17.2 0.848315 17.4 1.04735L24.6 8.21268C25 8.61075 25.1917 9.07517 25.175 9.60594C25.1583 10.1367 24.9667 10.6011 24.6 10.9992C24.2 11.3973 23.725 11.6046 23.175 11.6212C22.625 11.6378 22.15 11.447 21.75 11.049L18 7.31701V21.5482C18 22.1121 17.8083 22.5848 17.425 22.9663C17.0417 23.3478 16.5667 23.5385 16 23.5385C15.4333 23.5385 14.9583 23.3478 14.575 22.9663C14.1917 22.5848 14 22.1121 14 21.5482V7.31701Z"
                                    fill="white" fill-opacity="0.5" />
                            </svg>
                        </div>
                        {{ form.text_files(class="h-full w-full absolute top-0 left-0 opacity-0 cursor-pointer") }}
                    </label>
                    <div
                        class="flex items-center mt-3 bg-transparent border-custom-border border-[0.5px] rounded-lg ps-2 w-full focus-visible:outline-none py-1">
                        <span id="text-files-count">0 files selected</span>
                        <svg id="text-files-check" xmlns="http://www.w3.org/2000/svg"
                            class="text-[#4CD964] size-5 ml-1 hidden" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <path d="m9 12 2 2 4-4" />
                        </svg>
                    </div>
                </div>
            </div>
            <button type="submit"
                class="inter-800 mt-10 rounded-lg border-custom-border/50 border-[0.5px] shadow-2xl py-2 w-full font-semibold text-custom-text bg-primary-gradient hover:bg-primary-gradient/80">
                Generate Video
            </button>
        </div>
        <div class="col-span-2">
            <div class="w-full mb-3 bg-custom-gray rounded-lg p-3 border-custom-border border-[0.5px]">
                <h2 class="font-bold inter-800">Channels</h2>
            </div>
            <!-- 4 column grid for profiles -->
            <div class="grid grid-cols-4 gap-4">
                {% if profiles %}
                {% for profile in profiles %}
                <div class="relative">
                    <div
                        class="rounded-xl border-[0.5px] border-custom-border cursor-pointer flex justify-center items-center has-[:checked]:border-custom-primary has-[:checked]:outline-2 outline-custom-primary hover:border-primary/70 group">
                        <!-- Use form.profile as the source of radio buttons -->
                        {% for subfield in form.profile %}
                        {% if subfield.data == profile.id %}{{ subfield(id="profile-"+profile.id, class="hidden peer")
                        }}{% endif %}
                        {% endfor %}
                        <label for="profile-{{ profile.id }}" class="flex justify-center items-center px-12 py-2 ">
                            <img src="{{ profile.profile_pic }}"
                                class="size-16 rounded-full object-cover aspect-square max-w-16 bg-custom-gray">
                            <!-- Hover buttons - placed in corners -->
                            <div class="absolute inset-2 flex items-stretch justify-between pointer-events-none">
                                <!-- Edit button in top-right corner -->
                                <div
                                    class="absolute top-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto">
                                    <button type="button" data-modal-target="profile-modal"
                                        data-modal-toggle="profile-modal" data-profile-id="{{ profile.id }}"
                                        class="edit-profile-btn p-2 bg-blue-600 text-custom-text rounded-full hover:bg-blue-700 shadow-md">
                                        <svg class="size-3" fill="currentColor" viewBox="0 0 20 20"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                                <!-- Delete button in top-left corner -->
                                <div
                                    class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto">
                                    <button type="button" data-profile-id="{{ profile.id }}"
                                        class="delete-profile-btn p-2 bg-red-600 text-custom-text rounded-full hover:bg-red-700 shadow-md">
                                        <svg class="size-3" fill="currentColor" viewBox="0 0 20 20"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd"
                                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                clip-rule="evenodd">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="border-[0.5px] p-1 mt-2 rounded-lg border-custom-border text-center">
                        <h3 class="font-medium truncate text-sm">{{ profile.channel_name }}</h3>
                    </div>
                </div>
                {% endfor %}
                <!-- Create Profile Card (styled like other profile cards) -->
                <div class="relative">
                    <div
                        class="rounded-xl border-[0.5px] border-custom-border cursor-pointer flex justify-center items-center hover:border-primary/70 group">
                        <button type="button" data-modal-target="profile-modal" data-modal-toggle="profile-modal"
                            class="flex justify-center items-center px-12 py-2">
                            <div class="size-16 rounded-full flex items-center justify-center">
                                <svg class="size-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
            {% else %}
            <div class="col-span-full text-center py-10 text-custom-text">
                <p>No profiles found. Create your first profile to get started.</p>
            </div>
            <!-- Create Profile Card when no profiles exist (styled like other profile cards) -->
            <div class="relative mx-auto">
                <div
                    class="rounded-xl border-[0.5px] border-custom-border cursor-pointer flex justify-center items-center hover:border-primary/70 group">
                    <button type="button" data-modal-target="profile-modal" data-modal-toggle="profile-modal"
                        class="flex justify-center items-center px-12 py-2">
                        <div class="size-16 rounded-full flex items-center justify-center bg-custom-gray">
                            <svg class="size-8 text-custom-primary" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                    </button>
                </div>
                <div class="border-2 p-1 mt-2 rounded-lg border-custom-muted text-center">
                    <h3 class="font-medium truncate text-sm">Create Profile</h3>
                </div>
            </div>
            {% endif %}
        </div>
        </div>
        <div class="">
            <div class="w-full mb-3 bg-custom-gray rounded-lg p-3 border-custom-border border-[0.5px]">
                <div class="flex items-center gap-2">
                    <h2 class="font-bold inter-800">In queue</h2>
                </div>

            </div>
            <div id="queue-list" class="mt-3 space-y-2">
                <!-- In queue tasks will be shown here -->
                {% if tasks %}
                {% for task_id, task in tasks.items() if task.status not in ['complete', 'error', 'cancelled'] %}
                <div id="task-{{ task_id }}"
                    class="p-3 bg-custom-muted rounded-lg border-[0.5px] border-custom-border relative group">
                    <!-- Cancel button -->
                    <button type="button" onclick="cancelTask('{{ task_id }}')"
                        class="absolute top-1 right-1 size-5 flex items-center justify-center bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Cancel task">
                        <svg xmlns="http://www.w3.org/2000/svg" class="size-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="grid grid-cols-4 gap-3 items-center">
                        <!-- Profile picture (1/4 width) -->
                        <div class="flex justify-center items-center">
                            <div class="size-14 rounded-full bg-custom-gray/30 overflow-hidden">
                                <img src="/profiles/{{ task.profile_id }}/pfp.png" alt="Profile"
                                    class="h-full w-full object-cover"
                                    onerror="this.onerror=null; this.src='/static/img/default-pfp.png';" />
                            </div>
                        </div>

                        <!-- Task information (2/4 width) -->
                        <div class="col-span-2 flex flex-col justify-center">
                            <h3 class="font-medium text-base">{{ task.profile or 'Unknown profile' }}</h3>
                            <p class="text-sm text-custom-text/70">Status:
                                {% if task.status == 'processing' %}
                                <span class="text-purple-500">{{ task.stage or 'Processing' }}</span>
                                {% elif task.status == 'queued' %}
                                <span class="text-yellow-500">Queued</span>
                                {% elif task.status == 'initializing' %}
                                <span class="text-blue-500">Initializing</span>
                                {% else %}
                                <span class="text-gray-500">{{ task.stage or task.status or 'Processing' }}</span>
                                {% endif %}
                            </p>
                            <p class="text-sm text-custom-text/70">Amount: {% if task.files and task.files|length %}{{
                                task.files|length }} {{ 'file' if task.files|length == 1 else 'files' }}{% else %}No
                                files{% endif %}</p>
                            <p class="text-sm text-custom-text/70">Time: <span class="task-time"
                                    data-timestamp="{{ task.timestamp or '' }}">
                                    {{ task.timestamp }}
                                </span></p>

                        </div>

                        <!-- Status indicator (1/4 width) -->
                        <div class="flex justify-center items-center">
                            {% if task.status == 'processing' %}
                            <img src="/static/progress.png" alt="Processing" />
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-sm text-custom-text/60 py-2 text-center">No tasks in queue</div>
                {% endfor %}
                {% else %}
                <div class="text-sm text-custom-text/60 py-2 text-center">No tasks in queue</div>
                {% endif %}
            </div>

        </div>
        <div class="">
            <div class="w-full mb-3 bg-custom-gray rounded-lg p-3 border-custom-border border-[0.5px]">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold inter-800">Finished</h2>
                    <button type="button" onclick="deleteAllTasks()" 
                        class="p-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
                        title="Delete all finished tasks">
                        <svg xmlns="http://www.w3.org/2000/svg" class="size-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

            </div>
            <div id="finished-list" class="mt-3 space-y-2">
                <!-- Finished tasks will be shown here -->
                {% if tasks %}
                {% set completed_tasks = [] %}
                {% for task_id, task in tasks.items() if task.status in ['complete', 'error', 'cancelled'] %}
                {% do completed_tasks.append(task) %}
                {% endfor %}
                {% if completed_tasks %}
                {% for task in completed_tasks|sort(attribute='timestamp', reverse=true) %} <div
                    id="completed-task-{{ task.id }}"
                    class="p-3 bg-custom-muted rounded-lg border-[0.5px] border-custom-border relative group {% if task.status == 'complete' %}cursor-pointer hover:bg-custom-muted/80 transition-colors{% endif %}"
                    {% if task.status=='complete' %}onclick="openTaskFolder('{{ task.id }}', event)"
                    title="Click to open output folder" {% endif %}>
                    <!-- Delete button -->
                    <button type="button" onclick="deleteCompletedTask('{{ task.id }}')"
                        class="absolute top-1 right-1 size-5 z-20 flex items-center justify-center bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Delete from history">
                        <svg xmlns="http://www.w3.org/2000/svg" class="size-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="grid grid-cols-4 gap-3 items-center">
                        <!-- Profile picture (1/4 width) -->
                        <div class="flex justify-center items-center">
                            <div class="size-14 rounded-full bg-custom-gray/30 overflow-hidden">
                                <img src="/profiles/{{ task.profile_id }}/pfp.png" alt="Profile"
                                    class="h-full w-full object-cover"
                                    onerror="this.onerror=null; this.src='/static/img/default-pfp.png';" />
                            </div>
                        </div>

                        <!-- Task information (2/4 width) -->
                        <div class="col-span-2 flex flex-col justify-center">
                            <h3 class="font-medium text-base">{{ task.profile or 'Unknown profile' }}</h3>
                            <p class="text-sm text-custom-text/70">Status:
                                {% if task.status == 'complete' %}
                                <span class="text-green-500">Finished</span>
                            </p>
                            {% elif task.status == 'error' %}
                            <span class="text-red-500">Error</span></p>
                            {% elif task.status == 'cancelled' %}
                            <span class="text-yellow-500">Cancelled</span></p>
                            {% else %}
                            <span class="text-gray-500">{{ task.status }}</span></p>
                            {% endif %}
                            <p class="text-sm text-custom-text/70">Amount: {% if task.files and task.files|length %}{{
                                task.files|length }} {{ 'file' if task.files|length == 1 else 'files' }}{% else %}No
                                files{% endif %}</p>
                            <p class="text-sm text-custom-text/70">Time: <span class="task-time"
                                    data-timestamp="{{ task.timestamp or '' }}"
                                    data-end-timestamp="{{ task.end_time or '' }}" data-completed="true">
                                    {% if task.timestamp and task.end_time %}
                                    {% set start_time = task.timestamp|string %}
                                    {% set end_time = task.end_time|string %}
                                    {% set duration = (end_time|to_datetime - start_time|to_datetime) %}
                                    {{ duration|format_duration }}
                                    {% else %}
                                    {% if task.end_time %}
                                    {{ task.end_time }}
                                    {% else %}
                                    {{ task.timestamp }}
                                    {% endif %}
                                    {% endif %}
                                </span></p>
                        </div>

                        <!-- Status indicator (1/4 width) -->

                        <div class="flex justify-center items-center">
                            {% if task.status == 'complete' %}
                            <img src="/static/success.png" alt="Completed" />
                            {% elif task.status == 'error' %}
                            <img src="/static/error.png" alt="Error" />
                            {% elif task.status == 'cancelled' %}
                            <img src="/static/cancel.png" alt="Cancelled" />
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-sm text-custom-text/60 py-2 text-center">No completed tasks</div>
                {% endif %}
                {% else %}
                <div class="text-sm text-custom-text/60 py-2 text-center">No completed tasks</div>
                {% endif %}
            </div>

        </div>

    </form>
    <!-- Profile Modal (Unified for Create and Edit) -->
    <div id="profile-modal" tabindex="-1" aria-hidden="true"
        class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative w-full max-w-2xl max-h-full">
            <!-- Modal content -->
            <div class="relative bg-background rounded-2xl shadow-lg">
                <!-- Modal header -->
                <button type="button"
                    class="absolute top-0 right-0 text-custom-gray bg-transparent hover:bg-custom-muted hover:text-custom-text rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center"
                    data-modal-hide="profile-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
                <!-- Modal body -->
                <div class="px-6 py-4 space-y-6 text-custom-text">
                    <form id="profile-form" enctype="multipart/form-data">
                        <input type="hidden" id="profile_id" name="profile_id">
                        <div class="mb-6">
                            <label for="channel_name" class="w-full block my-1 font-semibold">Channel Name</label>
                            <input type="text" id="channel_name" name="channel_name"
                                class="bg-transparent text-custom-text border-custom-border border-[0.5px] rounded-lg ps-2 w-full focus-visible:outline-none py-1"
                                required>
                        </div>
                        <div class="mb-6">
                            <label class="w-full block my-1 text-lg font-semibold">Profile Picture</label>
                            <!-- Profile picture preview (Only shown when editing) -->
                            <div id="profile-pic-preview" class="items-center space-x-4 mb-2 hidden">
                                <div
                                    class="w-16 h-16 rounded-full overflow-hidden border-1 border-custom-border shadow-md flex items-center justify-center bg-custom-gray">
                                    <img id="current_profile_pic" src="" alt="Current profile picture"
                                        class="min-w-full min-h-full object-cover">
                                </div>
                                <div class="text-sm">Current profile picture</div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <label for="profile_pic"
                                    class="bg-custom-primary border-custom-border border-[0.5px] py-2 px-4 cursor-pointer rounded-2xl w-1/3 text-center font-semibold">
                                    Upload your Photo
                                </label>
                                <div class="bg-transparent py-2 px-3 rounded-2xl border-custom-border border-[0.5px] w-2/3 truncate "
                                    id="file-name-display">
                                    No file chosen
                                </div>

                            </div>
                            <input type="file" id="profile_pic" name="profile_pic" accept="image/*" class="hidden">
                        </div>

                        <!-- Font Selection -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block my-1 text-lg" for="font_select">Font</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="absolute size-[18px] top-2 left-2 text-custom-text" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M4 7V4h16v3" />
                                    <path d="M9 20h6" />
                                    <path d="M12 4v16" />
                                </svg>
                                <select id="font_select" name="font"
                                    class="ps-7 bg-background text-custom-text/70 border-custom-border border-[0.5px] rounded-lg w-full focus-visible:outline-none py-1">
                                    <option value="montserrat">Montserrat</option>
                                    <option value="fredoka">fredoka</option>
                                    <option value="noto">Noto Sans</option>
                                </select>
                            </div>
                        </div>

                        <!-- Voice Selection -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block my-1 text-lg" for="voice_select">Voice</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="absolute size-[18px] top-2 left-2 text-custom-text" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                    <line x1="12" x2="12" y1="19" y2="22" />
                                </svg>
                                <select id="voice_select" name="voice"
                                    class="ps-7 bg-background text-custom-text/70 border-custom-border border-[0.5px] rounded-lg w-full focus-visible:outline-none py-1">
                                    {% for voice_id, voice_name in form.voice.choices %}
                                    <option class="" value="{{ voice_id }}">{{ voice_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Limit Length -->
                        <div class="mb-6">
                            <label for="video_length" class="font-semibold w-full block my-1 text-lg">Limit Length (seconds)</label>
                            <input type="number" id="video_length" name="video_length" value="0" min="0" step="1"
                                class="bg-transparent text-custom-text border-custom-border border-[0.5px] rounded-lg ps-2 w-full focus-visible:outline-none py-1">
                            <p class="text-sm text-custom-text/60 mt-1">Set to 0 for no limit. Audio will be sped up to fit the specified length.</p>
                        </div>

                        <!-- Voice Model Selection -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block my-1 text-lg" for="voice_model_select">Voice Model</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="absolute size-[18px] top-2 left-2 text-custom-text" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                    <line x1="12" x2="12" y1="19" y2="22" />
                                </svg>
                                <select id="voice_model_select" name="voice_model"
                                    class="ps-7 bg-background text-custom-text/70 border-custom-border border-[0.5px] rounded-lg w-full focus-visible:outline-none py-1">
                                    {% for model_id, model_name in form.voice_model.choices %}
                                    <option class="" value="{{ model_id }}">{{ model_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                         
                        <!-- Music Selection -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block my-1 text-lg" for="music_select">Music</label>
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="absolute size-[18px] top-2 left-2 text-custom-text" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M9 18V5l12-2v13" />
                                    <circle cx="6" cy="18" r="3" />
                                    <circle cx="18" cy="16" r="3" />
                                </svg>
                                <select id="music_select" name="music"
                                    class="ps-7 bg-background text-custom-text/70 border-custom-border border-[0.5px] rounded-lg w-full focus-visible:outline-none py-1">
                                    <option value="none">None</option>
                                    {% if music_files %}
                                    {% for music in music_files %}
                                    <option value="{{ music.id }}">{{ music.name }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>

                        <!-- Background Video Selection -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block mb-2">Background Videos</label>
                            <!-- Grid for background videos -->
                            <div class="grid grid-cols-6 grid-rows-2 gap-3">
                                {% if background_videos %}
                                {% for video in background_videos %}
                                <div class="relative">
                                    <div
                                        class="rounded-lg border-[0.5px] cursor-pointer flex justify-center items-center has-[:checked]:border-custom-primary border-custom-border hover:border-primary/70 group">
                                        <input type="radio" id="video-{{ video.id }}" name="background_video"
                                            value="{{ video.id }}" class="hidden peer bg-radio">
                                        <label for="video-{{ video.id }}"
                                            class="flex flex-col justify-center items-center py-2 w-full">
                                            <span class="text-2xl">{{ video.emoji }}</span>
                                            <div class="mt-1 text-center">
                                                <h3 class="truncate font-semibold text-custom-text text-xs">{{
                                                    video.name }}</h3>
                                            </div>
                                        </label>
                                        <!-- Delete button in top-right corner -->
                                        <div
                                            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-auto">
                                            <button type="button" data-video-id="{{ video.id }}"
                                                class="delete-video-btn p-0.5 bg-red-600 text-white rounded-full hover:bg-red-700 shadow-md">
                                                <svg class="size-3.5" fill="currentColor" viewBox="0 0 20 20"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd"
                                                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                        clip-rule="evenodd">
                                                    </path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>                                {% endfor %}
                                <div class="relative">
                                    <div
                                        class="rounded-lg border-[0.5px] cursor-pointer flex justify-center items-center has-[:checked]:border-custom-primary border-custom-border hover:border-primary/70 group">
                                        <button type="button" data-modal-target="create-background-modal"
                                            data-modal-toggle="create-background-modal"
                                            class="flex flex-col justify-center items-center p-2 w-full">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="size-8" viewBox="0 0 24 24"
                                                fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10" />
                                                <path d="M8 12h8" />
                                                <path d="M12 8v8" />
                                            </svg>
                                            <div class="mt-1 text-center">
                                                <h3 class="truncate font-semibold text-custom-text text-xs">Add Mix</h3>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                            <div class="col-span-full text-center py-3 text-custom-gray">
                                <p class="text-sm">No background videos available.</p>
                            </div>
                            <div class="relative mx-auto">
                                <div
                                    class="rounded-2xl border-3 border-custom-light-gray cursor-pointer flex justify-center items-center hover:border-primary/70 group">
                                    <button type="button" data-modal-target="create-background-modal"
                                        data-modal-toggle="create-background-modal"
                                        class="flex flex-col justify-center items-center p-2 w-full">
                                        <span class="text-2xl">+</span>
                                        <div class="mt-1 text-center">
                                            <h3 class="truncate font-semibold text-custom-text text-xs">Add Mix</h3>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-6">
                            <label class="block mb-2 text-sm font-semibold">Select Badges</label>
                            <div class="grid grid-cols-6 gap-4 mt-2">
                                {% for badge in badges %}
                                <div
                                    class="flex flex-col items-center rounded-lg border-[0.5px] border-custom-border p-1">
                                    <div class=" mb-1">
                                        <img src="{{ url_for('get_badge', badge_name=badge) }}" alt="{{ badge }}"
                                            class="w-10 h-10">
                                    </div>
                                    <input id="badge-{{ loop.index }}" type="checkbox" name="badges" value="{{ badge }}"
                                        class="w-4 h-4 text-custom-primary bg-custom-light-gray border-gray-300 rounded focus:ring-primary/70 focus:ring-2 badge-checkbox">
                                </div>
                                {% endfor %}
                            </div>
                        </div>                        <!-- Highlight Color Selection -->
                        <div class="mb-6">
                            <label for="highlight_color" class="font-semibold w-full block my-1 text-lg">Highlight
                                Color</label>
                            <input type="color" id="highlight_color" name="highlight_color" value="#FFFFFF"
                                class="w-full h-12 border-custom-border border-[0.5px] rounded-lg cursor-pointer bg-transparent">
                        </div>

                        <!-- Animation Toggle -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block mb-1 text-lg">Animation Settings</label>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="animations_enabled" name="animations_enabled" checked
                                    class="w-5 h-5 text-custom-primary bg-transparent border-custom-border border-[0.5px] rounded focus:ring-custom-primary focus:ring-2">

                            </div>
                        </div>

                        <!-- Badge Style Selection with Card-like Radio Buttons -->
                        <div class="mb-6">
                            <label class="font-semibold w-full block mb-1 text-lg text-custom-primary ml-3">Badge
                                Style</label>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <div
                                        class="rounded-2xl border-3 cursor-pointer flex justify-center items-center has-[:checked]:border-custom-primary border-custom-light-gray hover:border-primary/70 group">
                                        <input type="radio" id="badge-style-blue" name="badge_style" value="blue"
                                            class="hidden peer">
                                        <label for="badge-style-blue"
                                            class="flex flex-col justify-center items-center p-2 w-full">
                                            <img src="{{ url_for('get_badge', badge_name='verified.png') }}"
                                                alt="Blue Verified" class="w-10 h-10">
                                        </label>
                                    </div>
                                </div>
                                <div class="relative">
                                    <div
                                        class="rounded-2xl border-3 cursor-pointer flex justify-center items-center has-[:checked]:border-custom-primary border-custom-light-gray hover:border-primary/70 group">
                                        <input type="radio" id="badge-style-gold" name="badge_style" value="gold"
                                            class="hidden peer">
                                        <label for="badge-style-gold"
                                            class="flex flex-col justify-center items-center p-2 w-full">
                                            <img src="{{ url_for('get_badge', badge_name='gold_verified.png') }}"
                                                alt="Gold Verified" class="w-10 h-10">

                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Modal footer -->
                    <div class="grid grid-cols-3 grid-rows-1 w-full gap-x-4">
                        <button type="button" id="profile-submit-btn"
                            class="py-2 text-center bg-custom-primary border-custom-border border-[0.5px] rounded-2xl col-span-2">
                            Save Changes
                        </button>
                        <button type="button"
                            class="py-2 text-center border-custom-border bg-custom-muted border-[0.5px] rounded-2xl col-span-1"
                            data-modal-hide="profile-modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div> <!-- Create Background Modal -->
        <div id="create-background-modal" tabindex="-1" aria-hidden="true"
            class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
            <div class="relative w-full max-w-md max-h-full">
                <!-- Modal content -->
                <div
                    class="relative bg-background rounded-2xl shadow-2xl drop-shadow-2xl border-custom-border border-1">
                    <!-- Modal close button -->
                    <button type="button"
                        class="absolute top-2 right-2 text-custom-gray bg-transparent hover:bg-custom-muted hover:text-custom-text rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center"
                        data-modal-hide="create-background-modal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>

                    <!-- Modal body -->
                    <div class="px-6 py-4 space-y-6 text-custom-text">
                        <form id="create-background-form">
                            <div class="mb-6">
                                <label for="mix_name" class="w-full block my-1 font-semibold">Mix Name</label>
                                <input type="text" id="mix_name" name="mix_name"
                                    class="bg-transparent text-custom-text border-custom-border border-[0.5px] rounded-lg ps-2 w-full focus-visible:outline-none py-1"
                                    required>
                            </div>
                            <div class="mb-6">
                                <label for="mix_emoji" class="w-full block my-1 font-semibold">Emoji</label>
                                <input type="text" id="mix_emoji" name="mix_emoji"
                                    class="bg-transparent text-custom-text border-custom-border border-[0.5px] rounded-lg ps-2 w-full focus-visible:outline-none py-1"
                                    placeholder="Emoji here" required>
                            </div>
                        </form>
                    </div>

                    <!-- Modal footer -->
                    <div class="grid grid-cols-3 grid-rows-1 w-full gap-x-4 px-6 pb-4">
                        <button type="button" id="create-background-submit"
                            class="py-2 text-center bg-custom-primary border-custom-border border-[0.5px] rounded-2xl col-span-2">
                            Create Mix
                        </button>
                        <button type="button"
                            class="py-2 text-center border-custom-border bg-custom-muted border-[0.5px] rounded-2xl col-span-1"
                            data-modal-hide="create-background-modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- JavaScript for profile management -->
        <!-- Your existing scripts -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // File upload display
                const profilePicInput = document.getElementById('profile_pic');
                const fileNameDisplay = document.getElementById('file-name-display');

                if (profilePicInput) {
                    profilePicInput.addEventListener('change', function () {
                        if (this.files.length > 0) {
                            fileNameDisplay.textContent = this.files[0].name;
                        } else {
                            fileNameDisplay.textContent = 'No file chosen';
                        }
                    });
                }

                // Profile modal handling
                const profileForm = document.getElementById('profile-form');
                const profileSubmitBtn = document.getElementById('profile-submit-btn');
                const profilePicPreview = document.getElementById('profile-pic-preview');

                // Handler for opening the profile modal for creating new profile
                const createProfileBtns = document.querySelectorAll('[data-modal-target="profile-modal"]:not(.edit-profile-btn)');
                createProfileBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        // Reset the form for creating a new profile
                        profileForm.reset();

                        // Set modal title for creating
                        if (profileModalTitle) {
                            profileModalTitle.textContent = 'Create Profile';
                        }

                        // Hide profile picture preview
                        profilePicPreview.classList.add('hidden');
                        profilePicPreview.classList.remove('flex');

                        // Clear profile ID (indicates it's a new profile)
                        document.getElementById('profile_id').value = '';

                        // Reset badge checkboxes
                        document.querySelectorAll('input[name="badges"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });

                        // Set default badge style to blue
                        document.getElementById('badge-style-blue').checked = true;

                        // Reset file name display
                        fileNameDisplay.textContent = 'No file chosen';
                    });
                });

                // Handler for opening the profile modal for editing
                const editProfileBtns = document.querySelectorAll('.edit-profile-btn');
                const profileModalTitle = document.getElementById('profile-modal-title'); // Get the modal title element

                editProfileBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const profileId = this.getAttribute('data-profile-id');

                        // Set modal title for editing
                        if (profileModalTitle) {
                            profileModalTitle.textContent = 'Edit Profile';
                        }

                        // Fetch profile data
                        fetch(`/profiles/${profileId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(profile => {
                                console.log("Loaded profile data:", profile);

                                // Set form values
                                document.getElementById('profile_id').value = profileId;

                                // Set channel name
                                const channelNameInput = document.getElementById('channel_name');
                                if (channelNameInput && profile.channel_name) {
                                    channelNameInput.value = profile.channel_name;
                                }

                                // Show profile picture preview
                                profilePicPreview.classList.remove('hidden');
                                profilePicPreview.classList.add('flex');
                                const currentPic = document.getElementById('current_profile_pic');
                                if (currentPic) {
                                    currentPic.src = `/profiles/${profileId}/pfp.png?t=${new Date().getTime()}`; // Add timestamp to prevent caching
                                }

                                // Set voice selection if it exists
                                const voiceSelect = document.getElementById('voice_select');
                                if (voiceSelect && profile.voice) {
                                    voiceSelect.value = profile.voice;
                                }

                                // Set font selection if it exists
                                const fontSelect = document.getElementById('font_select');
                                if (fontSelect) {
                                    if (profile.font) {
                                        fontSelect.value = profile.font;
                                    } else {
                                        fontSelect.value = 'montserrat'; // Default font
                                    }
                                }

                                // Set limit length if it exists
                                const limitLengthInput = document.getElementById('video_length');
                                if (limitLengthInput) {
                                    limitLengthInput.value = profile.video_length || 0;
                                }

                                // Set music selection if it exists
                                const musicSelect = document.getElementById('music_select');
                                if (musicSelect) {
                                    if (profile.music) {
                                        musicSelect.value = profile.music;
                                    } else {
                                        musicSelect.value = 'none';
                                    }
                                }                                // Set Highlight Color
                                if (profile.highlight_color) {
                                    const highlightColorInput = document.getElementById('highlight_color');
                                    if (highlightColorInput) {
                                        highlightColorInput.value = profile.highlight_color;
                                    }
                                }

                                // Set animations setting
                                const animationsCheckbox = document.getElementById('animations_enabled');
                                if (animationsCheckbox) {
                                    animationsCheckbox.checked = profile.animations_enabled !== false; // Default to true if not specified
                                }

                                // Set background video selection if it exists
                                if (profile.background_video) {
                                    const bgRadio = document.querySelector(`input[name="background_video"][value="${profile.background_video}"]`);
                                    if (bgRadio) bgRadio.checked = true;
                                }

                                // set model selection if it exists
                                const voiceModelSelect = document.getElementById('voice_model_select');
                                if (voiceModelSelect) {
                                    if (profile.voice_model) {
                                        voiceModelSelect.value = profile.voice_model;
                                    }
                                }

                                // Reset badge checkboxes
                                document.querySelectorAll('input[name="badges"]').forEach(checkbox => {
                                    checkbox.checked = false;
                                });

                                // Check the badges for this profile
                                if (profile.selected_badges && Array.isArray(profile.selected_badges)) {
                                    profile.selected_badges.forEach(badge => {
                                        const checkbox = document.querySelector(`input[name="badges"][value="${badge}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                }

                                // Set badge style radio
                                const badgeStyle = profile.badge_style || 'blue';
                                const badgeStyleRadio = document.getElementById(`badge-style-${badgeStyle}`);
                                if (badgeStyleRadio) badgeStyleRadio.checked = true;

                                // Reset file name display
                                fileNameDisplay.textContent = 'No file chosen';
                            })
                            .catch(error => {
                                console.error('Error fetching profile:', error);
                                alert('Failed to load profile data. Please try again.');
                            });
                    });
                });

                // Profile form submission (unified for create and edit)
                if (profileSubmitBtn && profileForm) {
                    profileSubmitBtn.addEventListener('click', function () {
                        const profileId = document.getElementById('profile_id').value;
                        const formData = new FormData(profileForm);

                        // Get all selected badges
                        const selectedBadges = [];
                        document.querySelectorAll('input[name="badges"]:checked').forEach(checkbox => {
                            selectedBadges.push(checkbox.value);
                        });

                        // FormData only sends the last value by default, so we need to append each badge separately
                        formData.delete('badges'); // Remove any existing badge entries
                        selectedBadges.forEach(badge => {
                            formData.append('badges', badge);
                        });

                        // Determine if this is an edit or create operation
                        const isEditMode = profileId !== '';

                        const url = isEditMode ? `/profiles/${profileId}` : '/profiles';
                        const method = isEditMode ? 'PUT' : 'POST';

                        fetch(url, {
                            method: method,
                            body: formData
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                window.location.reload();
                            })
                            .catch(error => {
                                console.error(`Error ${isEditMode ? 'updating' : 'creating'} profile:`, error);
                                alert(`Failed to ${isEditMode ? 'update' : 'create'} profile. Please try again.`);
                            });
                    });
                }

                // Create background video mix form submission
                const createBackgroundForm = document.getElementById('create-background-form');
                const createBackgroundSubmitBtn = document.getElementById('create-background-submit');

                if (createBackgroundSubmitBtn) {
                    createBackgroundSubmitBtn.addEventListener('click', function () {
                        const formData = new FormData(createBackgroundForm);

                        fetch('/background-videos', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                window.location.reload();
                            })
                            .catch(error => {
                                console.error('Error creating background mix:', error);
                                alert('Failed to create background mix. Please try again.');
                            });
                    });
                }

                // Delete profile functionality
                const deleteProfileBtns = document.querySelectorAll('.delete-profile-btn');

                deleteProfileBtns.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        // Prevent event from bubbling up to parent elements
                        e.preventDefault();
                        e.stopPropagation();

                        showCustomConfirm('Are you sure you want to delete this profile? This action cannot be undone.', () => {
                            const profileId = this.getAttribute('data-profile-id');

                            fetch(`/profiles/${profileId}`, {
                                method: 'DELETE'
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Server returned error status: ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Profile deleted successfully:', data);
                                    window.location.reload();
                                })
                                .catch(error => {
                                    console.error('Error deleting profile:', error);
                                    alert('Failed to delete profile. Please try again.');
                                });
                        });
                    });
                });

                // Delete background video functionality
                const deleteVideoBtns = document.querySelectorAll('.delete-video-btn');

                deleteVideoBtns.forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        // Prevent event from bubbling up to parent elements
                        e.preventDefault();
                        e.stopPropagation();

                        showCustomConfirm('Are you sure you want to delete this background video? This action cannot be undone.', () => {
                            const videoId = this.getAttribute('data-video-id');

                            if (!videoId) {
                                console.error('Missing video ID for deletion');
                                alert('Could not identify the video to delete. Please try again.');
                                return;
                            }

                            fetch(`/background-videos/${videoId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Server returned error status: ' + response.status);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('Video deleted successfully:', data);
                                    window.location.reload();
                                })
                                .catch(error => {
                                    console.error('Error deleting background video:', error);
                                    alert('Failed to delete background video. Please try again.');
                                });
                        });
                    });
                });
            });
            function showCustomConfirm(message, onConfirm) {
                const dialog = document.getElementById('custom-confirm-dialog');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmYesBtn = document.getElementById('confirm-yes-btn');
                const confirmNoBtn = document.getElementById('confirm-no-btn');

                confirmMessage.textContent = message;
                dialog.classList.remove('hidden');
                dialog.classList.add('flex');

                confirmYesBtn.onclick = function () {
                    dialog.classList.add('hidden');
                    dialog.classList.remove('flex');
                    onConfirm();
                };

                confirmNoBtn.onclick = function () {
                    dialog.classList.add('hidden');
                    dialog.classList.remove('flex');
                };
            }

            function deleteAllTasks() {
                showCustomConfirm('Are you sure you want to delete all finished tasks? This action cannot be undone.', () => {
                    // Get all completed task IDs
                    const completedTasks = document.querySelectorAll('[id^="completed-task-"]');
                    
                    if (completedTasks.length === 0) {
                        alert('No finished tasks to delete.');
                        return;
                    }

                    let deletedCount = 0;
                    let totalTasks = completedTasks.length;

                    completedTasks.forEach(taskElement => {
                        const taskId = taskElement.id.replace('completed-task-', '');
                        
                        fetch(`/task_action/${taskId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                deletedCount++;
                                taskElement.remove();
                                
                                // If all tasks are deleted, show empty message
                                if (deletedCount === totalTasks) {
                                    const finishedList = document.getElementById('finished-list');
                                    finishedList.innerHTML = '<div class="text-sm text-custom-text/60 py-2 text-center">No completed tasks</div>';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting task:', error);
                        });
                    });
                });
            }
        </script>
        <!-- JavaScript for file upload -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Text file upload handling
                const textFilesInput = document.getElementById('text_files');
                const textFilesCount = document.getElementById('text-files-count');
                const textFilesCheck = document.getElementById('text-files-check');
                const uploadStatus = document.getElementById('upload-status');
                const dropZone = document.querySelector('label[for="text_files"]');

                // Update file count and UI when files are selected
                textFilesInput.addEventListener('change', function () {
                    const numFiles = this.files.length;

                    if (numFiles > 0) {
                        // Update text with checkmark SVG
                        textFilesCount.innerHTML = `${numFiles} ${numFiles === 1 ? 'file' : 'files'} Uploaded`;
                        textFilesCheck.classList.remove('hidden');

                        textFilesCount.classList.add('text-[#4CD964]')

                    } else {
                        // Reset to default state
                        textFilesCount.textContent = "0 files selected";
                        textFilesCheck.classList.add('hidden');

                        textFilesCount.classList.remove('text-[#4CD964]')

                    }
                });

                // Support drag and drop functionality
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    dropZone.classList.add('bg-gray-400');
                }

                function unhighlight() {
                    dropZone.classList.remove('bg-gray-400');
                }

                dropZone.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    textFilesInput.files = files;

                    // Trigger the change event manually
                    const event = new Event('change');
                    textFilesInput.dispatchEvent(event);
                } // Form submission handling with confirmation
                const generationForm = document.getElementById('generation-form');
                if (generationForm) {
                    generationForm.addEventListener('submit', function (e) {
                        const filesInput = document.getElementById('text_files');
                        const selectedProfile = document.querySelector('input[name="profile"]:checked');

                        // Validate form before submission
                        if (filesInput.files.length === 0) {
                            e.preventDefault(); // Prevent form submission
                            alert('Please select at least one text file.');
                            return false;
                        }

                        if (!selectedProfile) {
                            e.preventDefault(); // Prevent form submission
                            alert('Please select a channel profile before submitting.');
                            return false;
                        }

                        // Form is valid, let it submit
                        return true;
                    });
                }
            });
        </script>
        <!-- JavaScript for task time handling -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Ensure completed task times are displayed correctly if server-side templating failed
                document.querySelectorAll('.task-time[data-completed="true"]').forEach(timeElement => {
                    const content = timeElement.textContent.trim();
                    // Check if the content seems to be a raw timestamp (server-side rendering failed)
                    if (content.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/) || content === '') {
                        const timestamp = timeElement.getAttribute('data-timestamp');
                        const endTimestamp = timeElement.getAttribute('data-end-timestamp');

                        if (timestamp && endTimestamp) {
                            try {
                                const startDate = new Date(timestamp);
                                const endDate = new Date(endTimestamp);

                                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                                    const durationMs = endDate - startDate;
                                    const durationSec = Math.round(durationMs / 1000);
                                    const durationMin = Math.round(durationSec / 60);
                                    const durationHour = Math.floor(durationMin / 60);
                                    const remainingMin = durationMin % 60;

                                    let duration = '';
                                    if (durationHour > 0) {
                                        duration = `${durationHour}h ${remainingMin}m`;
                                    } else if (durationMin > 0) {
                                        duration = `${durationMin}m`;
                                    } else {
                                        duration = `${durationSec}s`;
                                    }

                                    timeElement.textContent = duration;
                                }
                            } catch (err) {
                                console.error("Error calculating task duration:", err);
                            }
                        }
                    }
                });
            });
        </script>
</body>
{% endblock %}